<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìš´ì˜ì‹¤ ì¶œì…ê´€ë¦¬ - ì¶œì… ë“±ë¡</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --sidebar-bg-color: #1a253c;
      --main-bg-color: #f4f7fc;
      --card-bg-color: #ffffff;
      --primary-accent-color: #4a6cf7;
      --text-color-light: #f8f9fa;
      --text-color-dark: #343a40;
      --text-color-muted: #6c757d;
    }

    body, html {
      height: 100%;
      margin: 0;
      background-color: var(--main-bg-color);
      font-family: 'Noto Sans KR', sans-serif;
    }

    .main-container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 280px;
      background-color: var(--sidebar-bg-color);
      color: var(--text-color-light);
      padding: 40px 0px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      flex-shrink: 0;
    }

    .sidebar a {
        text-decoration: none;
        color: var(--text-color-light);
    }

    .sidebar h2 {
      font-weight: 700;
      margin-bottom: 10px;
      letter-spacing: -1px;
    }
    
    .sidebar p {
      font-size: 0.9rem;
      opacity: 0.7;
    }

    .sidebar-submenu a {
      display: block;
      width: 100%;
      color: #f8f9fa;
      text-decoration: none;
      padding: 10px 0 10px 52px;
      box-sizing: border-box;
      transition: background-color 0.2s ease;
    }

    .sidebar-submenu a:hover,
    .sidebar-submenu a.active {
      background-color: rgba(255, 255, 255, 0.25);
      font-weight: bold;
    }

    .content-area {
      flex-grow: 1;
      padding: 40px;
      overflow-y: auto;
    }

    .form-card {
      background-color: var(--card-bg-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 20px 40px 40px 40px;
      max-width: 900px;
      margin: auto;
    }

    .form-card h2 {
      font-weight: bold;
      margin-top: 0;
      margin-bottom: 30px;
      text-align: center;
      color: var(--text-color-dark);
    }

    .form-card fieldset {
      border: 1px solid #dee2e6;
      border-radius: 5px;
    }

    .form-card legend {
      font-size: 1.1em;
      font-weight: 600;
    }

    .form-control, .form-select {
        background-color: #f8f9fa;
    }

    /* ì„œëª… íŒ¨ë“œ ìŠ¤íƒ€ì¼ */
    .signature-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .signature-pad {
      border: 2px dashed #dee2e6;
      border-radius: 5px;
      cursor: crosshair;
      background-color: #ffffff;
      width: 100%;
      height: 120px;
      transition: border-color 0.3s;
    }

    .signature-pad:hover {
      border-color: #4a6cf7;
    }

    .signature-pad.signing {
      border-color: #4a6cf7;
      border-style: solid;
    }

    .signature-controls {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .signature-hint {
      font-size: 0.85rem;
      color: var(--text-color-muted);
    }

    .clear-signature {
      background: none;
      border: none;
      color: #dc3545;
      font-size: 0.85rem;
      text-decoration: underline;
      cursor: pointer;
      padding: 0;
    }

    .clear-signature:hover {
      color: #c82333;
    }

    /* NFC ìŠ¤íƒ€ì¼ */
    .nfc-container {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
    }

    .nfc-button {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.4);
      color: white;
      padding: 5px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .nfc-button:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.6);
    }

    .nfc-status {
      font-size: 12px;
      margin-top: 8px;
    }

    .nfc-message {
      margin-top: 10px;
      border-radius: 4px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 992px) {
      .main-container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        position: static;
        padding: 20px;
      }
      .content-area {
        padding: 20px;
      }
    }

    /* ì‘ì—…ê³„íšì„œ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .plan-item {
      padding: 12px;
      margin-bottom: 8px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      background-color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .plan-item:hover {
      background-color: #e3f2fd;
      border-color: #2196f3;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15);
    }

    .plan-item.selected {
      background-color: #e8f5e8;
      border-color: #28a745;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }

    .plan-item-header {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .plan-item-details {
      font-size: 0.9em;
      color: #6c757d;
    }

    .plan-item-registrant {
      display: inline-block;
      background: #e9ecef;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="sidebar">
      <a href="index.html">
        <h2>ìš´ì˜ì‹¤ ì¶œì…ê´€ë¦¬</h2>
        <p>Access Management System</p>
      </a>
      <div style="margin-top: 20px; font-size: 1.2rem; text-align: left; width: 100%;">
        <ul class="list-unstyled sidebar-submenu">
          <li><a href="/register.html" class="active">ã†ì¶œì… ë“±ë¡</a></li>
          <li><a href="/exit.html">ã†í‡´ì‹¤ ë“±ë¡</a></li>
          <li><a href="/verify.html">ã†ì±…ì„ì í™•ì¸</a></li>
          <li><a href="#" onclick="goToSettings()">ã†ì„¤ì •</a></li>
        </ul>  
      </div>
    </div>
    <div class="content-area">
      <div class="form-card">
        <h2>ì¶œì… ë“±ë¡</h2>
        <form id="entryForm">
          <fieldset class="border p-3 mb-4">
            <legend class="float-none w-auto px-2">ì¶œì…ì ì •ë³´ (ì™¸ë¶€ì§ì›)</legend>
            <div class="row">
              <div class="col-md-7">
                <div class="mb-3">
                  <label class="form-label">ì´ë¦„</label>
                  <input type="text" class="form-control" name="name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">ì†Œì†(íšŒì‚¬ëª…)</label>
                  <input type="text" class="form-control" name="company" required>
                </div>
              </div>
              <div class="col-md-5">
                <label class="form-label">ì¶œì…ì ì„œëª…</label>
                <div class="signature-container">
                  <canvas class="signature-pad" id="entrySignaturePad" width="400" height="150"></canvas>
                  <div class="signature-controls">
                    <span class="signature-hint">ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì„œëª…í•´ì£¼ì„¸ìš”</span>
                    <button type="button" class="clear-signature" onclick="clearSignature('entrySignaturePad')">ì§€ìš°ê¸°</button>
                  </div>
                </div>
                <input type="hidden" name="entry_sign" id="entrySignatureData">
              </div>
            </div>
          </fieldset>
    
          <fieldset class="border p-3 mb-4">
            <legend class="float-none w-auto px-2">ì…íšŒì ì •ë³´ (ë†í˜‘ ì§ì›)</legend>
            <!-- NFC ì¹´ë“œ ë¦¬ë” UI - ë§¨ ìœ„ë¡œ ì´ë™ -->
            <div class="mb-4">
              <div class="nfc-container" id="nfcContainer">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span><i class="fas fa-credit-card"></i> ì‚¬ì›ì¦ ìë™ ì…ë ¥</span>
                  <div>
                    <button type="button" id="nfcStartBtn" onclick="startNFC()" class="nfc-button">
                      <i class="fas fa-wifi"></i> ì¹´ë“œ íƒœê·¸
                    </button>
                    <button type="button" id="nfcStopBtn" onclick="stopNFC()" class="nfc-button" style="display: none;">
                      <i class="fas fa-stop"></i> ì¤‘ì§€
                    </button>
                  </div>
                </div>
                <div id="nfcStatus" class="nfc-status"></div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-7">
                <div class="mb-3">
                  <label class="form-label">ì´ë¦„</label>
                  <input type="text" class="form-control" name="witness_name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">ì†Œì† íŒ€</label>
                  <select class="form-select" name="witness_team" required>
                    <option value="">íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ITìì²´ê°ì‚¬íŒ€">ITìì²´ê°ì‚¬íŒ€</option>
                    <option value="ì‹œìŠ¤í…œíŒ€">ì‹œìŠ¤í…œíŒ€</option>
                    <option value="ë³´ì•ˆíŒ€">ë³´ì•ˆíŒ€</option>
                    <option value="ë„¤íŠ¸ì›Œí¬íŒ€">ë„¤íŠ¸ì›Œí¬íŒ€</option>
                    <option value="ë°ì´í„°íŒ€">ë°ì´í„°íŒ€</option>
                  </select>
                </div>
              </div>
              <div class="col-md-5">
                <label class="form-label">ì…íšŒì ì„œëª…</label>
                <div class="signature-container">
                  <canvas class="signature-pad" id="witnessSignaturePad" width="400" height="150"></canvas>
                  <div class="signature-controls">
                    <span class="signature-hint">ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì„œëª…í•´ì£¼ì„¸ìš”</span>
                    <button type="button" class="clear-signature" onclick="clearSignature('witnessSignaturePad')">ì§€ìš°ê¸°</button>
                  </div>
                </div>
                <input type="hidden" name="witness_sign" id="witnessSignatureData">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">
                ì‘ì—…ê³„íšì„œ ë²ˆí˜¸ 
                <small class="text-muted">(ì…íšŒì ì´ë¦„ ì…ë ¥ì‹œ ìë™ ì¡°íšŒë¨)</small>
              </label>
              <div id="planSearchSection">
                <div class="d-flex gap-2 mb-2">
                  <button type="button" class="btn btn-outline-primary" id="searchPlanBtn">
                    <i class="fas fa-search"></i> ì‘ì—…ê³„íšì„œ ì¡°íšŒ
                  </button>
                  <button type="button" class="btn btn-outline-secondary" id="directInputBtn">
                    <i class="fas fa-edit"></i> ì§ì ‘ ì…ë ¥
                  </button>
                </div>
                <!-- ì‘ì—…ê³„íšì„œ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ ì˜ì—­ -->
                <div id="searchResults" class="d-none mb-2">
                  <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                    <div id="planList"></div>
                  </div>
                  <small class="text-muted">ì›í•˜ëŠ” ì‘ì—…ê³„íšì„œë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ê±°ë‚˜ 'ì§ì ‘ ì…ë ¥'ì„ ì´ìš©í•˜ì„¸ìš”.</small>
                </div>
                <div id="directInputSection" class="d-none">
                  <input type="text" class="form-control" name="plan_number" placeholder="ì‘ì—…ê³„íšì„œ ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”">
                  <small class="text-muted">ì‘ì—…ê³„íšì„œ ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</small>
                </div>
                <!-- ì„ íƒëœ ì‘ì—…ê³„íšì„œ í‘œì‹œ -->
                <div id="selectedPlan" class="d-none mt-2">
                  <div class="alert alert-info" role="alert">
                    <strong>âœ… ì„ íƒëœ ì‘ì—…ê³„íšì„œ:</strong>
                    <div id="selectedPlanInfo"></div>
                  </div>
                </div>
                <input type="hidden" name="plan_number_final" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">ì¶œì…ì‚¬ìœ </label>
              <div class="d-flex align-items-center gap-3">
                <input type="text" class="form-control" name="reason" required id="reasonInput">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="sameAsWorkplan">
                  <label class="form-check-label" for="sameAsWorkplan">
                    ì‘ì—…ê³„íšì„œì— ê¸°ì¬ëœ ì‚¬ìœ ì™€ ë™ì¼
                  </label>
                </div>
              </div>
            </div>
          </fieldset>
    
          <div class="text-center mt-2">
            <button type="submit" class="btn btn-primary btn-lg">ì¶œì… ë“±ë¡</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ğŸ“¡ NFC ì¹´ë“œ ë¦¬ë” ë³€ìˆ˜
    let nfcPolling = false;
    let nfcInterval = null;

    // ğŸ¯ NFC ì½ê¸° ì‹œì‘
    async function startNFC() {
      if (nfcPolling) return;
      
      try {
        // Python ì„œë²„ ì—°ê²° í™•ì¸
        const response = await fetch('http://localhost:8080/nfc/status');
        if (!response.ok) throw new Error('ì—°ê²° ì‹¤íŒ¨');
        
        nfcPolling = true;
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('nfcStartBtn').style.display = 'none';
        document.getElementById('nfcStopBtn').style.display = 'inline-block';
        document.getElementById('nfcStatus').textContent = 'ì¹´ë“œë¥¼ ë¦¬ë”ê¸°ì— íƒœê·¸í•´ì£¼ì„¸ìš”...';
        document.getElementById('nfcStatus').style.color = '#fff';
        
        // ì¹´ë“œ ì •ë³´ í´ë§ ì‹œì‘
        nfcInterval = setInterval(checkForCard, 1000);
        
        console.log('ğŸš€ NFC ì½ê¸° ì‹œì‘ë¨');
        
      } catch (error) {
        alert('Python NFC ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nsimple_nfc_web.pyë¥¼ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.\n\nì‹¤í–‰ ë°©ë²•:\n1. í„°ë¯¸ë„ ì—´ê¸°\n2. python simple_nfc_web.py ì…ë ¥');
        console.error('NFC ì‹œì‘ ì˜¤ë¥˜:', error);
      }
    }

    // ğŸ›‘ NFC ì½ê¸° ì¤‘ì§€
    function stopNFC() {
      nfcPolling = false;
      if (nfcInterval) {
        clearInterval(nfcInterval);
        nfcInterval = null;
      }
      
      // UI ì—…ë°ì´íŠ¸
      document.getElementById('nfcStartBtn').style.display = 'inline-block';
      document.getElementById('nfcStopBtn').style.display = 'none';
      document.getElementById('nfcStatus').textContent = '';
      
      console.log('ğŸ›‘ NFC ì½ê¸° ì¤‘ì§€ë¨');
    }

    // ğŸ“‹ ì¹´ë“œ ì •ë³´ í™•ì¸
    async function checkForCard() {
      if (!nfcPolling) return;
      
      try {
        const response = await fetch('http://localhost:8080/nfc/latest');
        const data = await response.json();
        
        if (data.cardId) {
          console.log('ğŸ“± ì¹´ë“œ ê°ì§€:', data);
          
          if (data.success && data.employee) {
            // âœ… ì‚¬ì› ì •ë³´ ìë™ ì…ë ¥
            const nameField = document.querySelector('input[name="witness_name"]');
            const teamField = document.querySelector('select[name="witness_team"]');
            
            // ì´ë¦„ ì…ë ¥
            nameField.value = data.employee.name;
            nameField.dispatchEvent(new Event('input', { bubbles: true }));
            
            // íŒ€ ì„ íƒ (ìë™ ì…ë ¥)
            teamField.value = data.employee.team;
            teamField.dispatchEvent(new Event('change', { bubbles: true }));
            
            // ğŸ“‹ í•´ë‹¹ ë‹´ë‹¹ìì˜ ì‘ì—…ê³„íšì„œ ìë™ ì¡°íšŒ
            console.log(`ğŸ” ${data.employee.name}ë‹˜ì˜ ì‘ì—…ê³„íšì„œ ìë™ ì¡°íšŒ ì‹œì‘...`);
            setTimeout(() => {
              searchWorkplans(data.employee.name);
            }, 500); // 0.5ì´ˆ í›„ ì¡°íšŒ (UI ì—…ë°ì´íŠ¸ ì™„ë£Œ í›„)
            
            // íŒ€ ì„ íƒì´ ì œëŒ€ë¡œ ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (teamField.value !== data.employee.team) {
              console.warn(`âš ï¸ íŒ€ "${data.employee.team}"ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.`);
              showNFCMessage(`âœ… ${data.employee.name}ë‹˜ ì •ë³´ ì…ë ¥ ì™„ë£Œ!\nğŸ“‹ ì‘ì—…ê³„íšì„œ ìë™ ì¡°íšŒ ì¤‘...\nâš ï¸ íŒ€ "${data.employee.team}"ì„ ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.`, 'warning');
            } else {
              // ì„±ê³µ ë©”ì‹œì§€ (ì´ë¦„, íŒ€, ì‘ì—…ê³„íšì„œ ëª¨ë‘ ìë™ ì²˜ë¦¬)
              showNFCMessage(`âœ… ${data.employee.name}ë‹˜ (${data.employee.team}) ì •ë³´ ì…ë ¥ ì™„ë£Œ!\nğŸ“‹ ì‘ì—…ê³„íšì„œ ìë™ ì¡°íšŒ ì¤‘...`, 'success');
            }
            
            // ìë™ìœ¼ë¡œ ì¤‘ì§€
            stopNFC();
            
          } else {
            // âŒ ì‹¤íŒ¨ ë©”ì‹œì§€
            showNFCMessage(`âš ï¸ ë“±ë¡ë˜ì§€ ì•Šì€ ì¹´ë“œì…ë‹ˆë‹¤\nì¹´ë“œ ID: ${data.cardId}`, 'error');
          }
        }
      } catch (error) {
        console.error('ì¹´ë“œ í™•ì¸ ì˜¤ë¥˜:', error);
      }
    }

    // ğŸ’¬ NFC ë©”ì‹œì§€ í‘œì‹œ
    function showNFCMessage(message, type) {
      // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
      const existingMsg = document.querySelector('.nfc-message');
      if (existingMsg) existingMsg.remove();
      
      // íƒ€ì…ë³„ ìŠ¤íƒ€ì¼ ì„¤ì •
      let alertClass, iconClass;
      switch(type) {
        case 'success':
          alertClass = 'alert-success';
          iconClass = 'check-circle';
          break;
        case 'warning':
          alertClass = 'alert-warning';
          iconClass = 'exclamation-triangle';
          break;
        case 'error':
        default:
          alertClass = 'alert-danger';
          iconClass = 'exclamation-triangle';
          break;
      }
      
      // ìƒˆ ë©”ì‹œì§€ ìƒì„±
      const msgDiv = document.createElement('div');
      msgDiv.className = `alert nfc-message ${alertClass}`;
      msgDiv.innerHTML = `
        <i class="fas fa-${iconClass}"></i> 
        ${message.replace(/\n/g, '<br>')}
      `;
      
      // ë©”ì‹œì§€ í‘œì‹œ
      document.getElementById('nfcContainer').appendChild(msgDiv);
      
      // 5ì´ˆ í›„ ì œê±° (warningì€ ì¢€ ë” ì˜¤ë˜ í‘œì‹œ)
      const timeout = type === 'warning' ? 5000 : 3000;
      setTimeout(() => {
        if (msgDiv.parentNode) msgDiv.remove();
      }, timeout);
    }

    // ì„œëª… íŒ¨ë“œ ì´ˆê¸°í™”
    function initSignaturePad(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      let isDrawing = false;
      let lastX = 0;
      let lastY = 0;

      // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • (ì‹¤ì œ í”½ì…€ í¬ê¸°ì™€ CSS í¬ê¸° ë§ì¶”ê¸°)
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì •
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);

      // í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ ì§€ì›)
      canvas.addEventListener('touchstart', handleTouch);
      canvas.addEventListener('touchmove', handleTouch);
      canvas.addEventListener('touchend', stopDrawing);

      function startDrawing(e) {
        isDrawing = true;
        canvas.classList.add('signing');
        [lastX, lastY] = getMousePos(canvas, e);
      }

      function draw(e) {
        if (!isDrawing) return;
        
        const [currentX, currentY] = getMousePos(canvas, e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        
        [lastX, lastY] = [currentX, currentY];
        
        // ì„œëª… ë°ì´í„° ì—…ë°ì´íŠ¸
        updateSignatureData(canvasId);
      }

      function stopDrawing() {
        if (!isDrawing) return;
        isDrawing = false;
        canvas.classList.remove('signing');
        updateSignatureData(canvasId);
      }

      function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                          e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
      }

      function getMousePos(canvas, e) {
        const rect = canvas.getBoundingClientRect();
        return [
          e.clientX - rect.left,
          e.clientY - rect.top
        ];
      }
    }

    // ì„œëª… ë°ì´í„° ì—…ë°ì´íŠ¸
    function updateSignatureData(canvasId) {
      const canvas = document.getElementById(canvasId);
      const dataURL = canvas.toDataURL('image/png');
      
      if (canvasId === 'entrySignaturePad') {
        document.getElementById('entrySignatureData').value = dataURL;
      } else if (canvasId === 'witnessSignaturePad') {
        document.getElementById('witnessSignatureData').value = dataURL;
      }
    }

    // ì„œëª… ì§€ìš°ê¸°
    function clearSignature(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (canvasId === 'entrySignaturePad') {
        document.getElementById('entrySignatureData').value = '';
      } else if (canvasId === 'witnessSignaturePad') {
        document.getElementById('witnessSignatureData').value = '';
      }
    }

    // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // ì„œëª… íŒ¨ë“œ ì´ˆê¸°í™”
      initSignaturePad('entrySignaturePad');
      initSignaturePad('witnessSignaturePad');
      
      // ğŸ“‹ ì…íšŒì ì´ë¦„ í•„ë“œì— ìë™ ì¡°íšŒ ê¸°ëŠ¥ ì¶”ê°€
      const witnessNameField = document.querySelector('input[name="witness_name"]');
      let autoSearchTimeout = null;
      
      witnessNameField.addEventListener('input', function(e) {
        const witnessName = e.target.value.trim();
        
        // ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
        if (autoSearchTimeout) {
          clearTimeout(autoSearchTimeout);
        }
        
        // ì´ë¦„ì´ 2ê¸€ì ì´ìƒì¼ ë•Œ 1ì´ˆ í›„ ìë™ ì¡°íšŒ
        if (witnessName.length >= 2) {
          autoSearchTimeout = setTimeout(() => {
            console.log(`ğŸ” ${witnessName}ë‹˜ì˜ ì‘ì—…ê³„íšì„œ ìë™ ì¡°íšŒ ì¤‘...`);
            searchWorkplans(witnessName);
          }, 1000);
        } else {
          // ì´ë¦„ì´ ì§§ìœ¼ë©´ ì‘ì—…ê³„íšì„œ ì„¹ì…˜ ì´ˆê¸°í™”
          resetPlanSection();
        }
      });
      
      // í˜ì´ì§€ ì¢…ë£Œì‹œ NFC ì¤‘ì§€
      window.addEventListener('beforeunload', () => {
        stopNFC();
      });

      // ğŸ’¡ ì‚¬ìš©ë²• ì½˜ì†” ì¶œë ¥
      console.log('%cğŸš€ NFC ì¶œì…ê´€ë¦¬ ì‹œìŠ¤í…œ', 'color: #17a2b8; font-size: 16px; font-weight: bold;');
      console.log('ğŸ“‹ ì‹œìŠ¤í…œ êµ¬ì„±:');
      console.log('  â€¢ ğŸ¯ NFC ê¸°ëŠ¥: Python ì„œë¹„ìŠ¤ (simple_nfc_web.py)');
      console.log('  â€¢ ğŸ“ ì‘ì—…ê³„íšì„œ: ì›¹ ë¡œì»¬ ë°ì´í„° (HTML/JavaScript)');
      console.log('  â€¢ âœï¸  ì„œëª… íŒ¨ë“œ: Canvas ê¸°ë°˜');
      console.log('  â€¢ ğŸ’¾ ë°ì´í„° ì €ì¥: Node.js ì„œë²„ (server.js)');
      console.log('');
      console.log('ğŸ® ì‚¬ìš© ë°©ë²•:');
      console.log('  1. Python ì‹¤í–‰: python simple_nfc_web.py');
      console.log('  2. "ì¹´ë“œ íƒœê·¸" ë²„íŠ¼ í´ë¦­');
      console.log('  3. ì‚¬ì›ì¦ì„ NFC ë¦¬ë”ê¸°ì— íƒœê·¸');
      console.log('  4. ìë™ìœ¼ë¡œ ì´ë¦„, íŒ€, ì‘ì—…ê³„íšì„œ ì…ë ¥ë¨!');
      console.log('');
      console.log('ğŸ“‹ ì‘ì—…ê³„íšì„œ ë°ì´í„°:');
      console.log(`  â€¢ ì´ ${WORKPLAN_SAMPLE_DATA.length}ê±´ì˜ ìƒ˜í”Œ ë°ì´í„°`);
      console.log('  â€¢ ë‹´ë‹¹ìë³„ ìë™ í•„í„°ë§');
      console.log('  â€¢ ì‚¬ìœ  ìë™ ì…ë ¥ ì§€ì›');
      console.log('');
      console.log('ğŸ”§ ë°ì´í„° ìˆ˜ì •:');
      console.log('  â€¢ ì‚¬ì› ì •ë³´: Pythonì˜ EMPLOYEE_DB');
      console.log('  â€¢ ì‘ì—…ê³„íšì„œ: HTMLì˜ WORKPLAN_SAMPLE_DATA');
      console.log('');
      console.log('ğŸ“¡ NFC API:');
      console.log('  â€¢ /nfc/latest - ìµœì‹  ì¹´ë“œ ì •ë³´');
      console.log('  â€¢ /nfc/status - NFC ìƒíƒœ');
    });

    // í¼ ì œì¶œ ì´ë²¤íŠ¸
    document.getElementById('entryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // NFC ì½ê¸° ì¤‘ì§€
      stopNFC();
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      
      // plan_number_final ê°’ì„ plan_numberë¡œ ë³€ê²½
      if (data.plan_number_final) {
        data.plan_number = data.plan_number_final;
        delete data.plan_number_final;
      }
      
      // ì‘ì—…ê³„íšì„œ ë²ˆí˜¸ê°€ ì„ íƒ/ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
      if (!data.plan_number) {
        alert('ì‘ì—…ê³„íšì„œë¥¼ ì¡°íšŒí•˜ê±°ë‚˜ ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì¶œì…ì‚¬ìœ  í™•ì¸
      if (!data.reason) {
        alert('ì¶œì…ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ì„œëª… í™•ì¸
      if (!data.entry_sign) {
        alert('ì¶œì…ì ì„œëª…ì„ í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!data.witness_sign) {
        alert('ì…íšŒì ì„œëª…ì„ í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('âœ… ì¶œì… ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          e.target.reset();
          // ì„œëª… íŒ¨ë“œì™€ ì‘ì—…ê³„íšì„œ ì„¹ì…˜ ì´ˆê¸°í™”
          clearSignature('entrySignaturePad');
          clearSignature('witnessSignaturePad');
          resetPlanSection();
        } else {
          const result = await response.json();
          alert('âŒ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.message || 'ì„œë²„ ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('âŒ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ì‘ì—…ê³„íšì„œ ì¡°íšŒ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('searchPlanBtn').addEventListener('click', () => {
      searchWorkplans(); // ì „ì²´ ì¡°íšŒ
    });

    // ğŸ“‹ ì‘ì—…ê³„íšì„œ ìƒ˜í”Œ ë°ì´í„° (HTMLì—ì„œ ê´€ë¦¬)
    const WORKPLAN_SAMPLE_DATA = [
      { id: 'WP-2025-001', title: 'ì„œë²„ ì •ê¸°ì ê²€ ì‘ì—…', registrant: 'ì„ì •í™˜', team: 'ITìì²´ê°ì‚¬íŒ€', reason: 'ì„œë²„ ì •ê¸°ì ê²€ ë° ë³´ì•ˆíŒ¨ì¹˜ ì ìš©' },
      { id: 'WP-2025-002', title: 'ë„¤íŠ¸ì›Œí¬ ì¥ë¹„ êµì²´', registrant: 'ì„ì •í™˜', team: 'ITìì²´ê°ì‚¬íŒ€', reason: 'ë…¸í›„ ë„¤íŠ¸ì›Œí¬ ì¥ë¹„ êµì²´ ì‘ì—…' },
      { id: 'WP-2025-003', title: 'DB ë°±ì—… ì‹œìŠ¤í…œ êµ¬ì¶•', registrant: 'ì„ì •í™˜', team: 'ITìì²´ê°ì‚¬íŒ€', reason: 'DB ë°±ì—… ì‹œìŠ¤í…œ êµ¬ì¶• ë° í…ŒìŠ¤íŠ¸' },
      { id: 'WP-2025-004', title: 'ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ì ê²€', registrant: 'ì„ì •í™˜', team: 'ITìì²´ê°ì‚¬íŒ€', reason: 'ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ì·¨ì•½ì  ì ê²€ ë° ë³´ê°•' },
      { id: 'WP-2025-005', title: 'ì‹œìŠ¤í…œ ì„±ëŠ¥ ìµœì í™”', registrant: 'ì„ì •í™˜', team: 'ITìì²´ê°ì‚¬íŒ€', reason: 'ì‹œìŠ¤í…œ ì„±ëŠ¥ ë¶„ì„ ë° ìµœì í™” ì‘ì—…' },
      { id: 'WP-2025-006', title: 'ë°©í™”ë²½ ì •ì±… ì—…ë°ì´íŠ¸', registrant: 'ë°•ë¯¼ìˆ˜', team: 'ë³´ì•ˆíŒ€', reason: 'ë°©í™”ë²½ ì •ì±… ê²€í†  ë° ì—…ë°ì´íŠ¸' },
      { id: 'WP-2025-007', title: 'ë°±ì—… ì‹œìŠ¤í…œ ì ê²€', registrant: 'ì •ë¯¼í˜¸', team: 'ë„¤íŠ¸ì›Œí¬íŒ€', reason: 'ë°±ì—… ì‹œìŠ¤í…œ ì •ê¸° ì ê²€ ë° ë³µêµ¬ í…ŒìŠ¤íŠ¸' },
      { id: 'WP-2025-008', title: 'ë°ì´í„°ë² ì´ìŠ¤ ì •ë¦¬', registrant: 'ìµœì˜ì§„', team: 'ë°ì´í„°íŒ€', reason: 'ë°ì´í„°ë² ì´ìŠ¤ ì •ë¦¬ ë° ì¸ë±ìŠ¤ ìµœì í™”' },
      { id: 'WP-2025-009', title: 'ì›¹ì„œë²„ ë³´ì•ˆ ê°•í™”', registrant: 'ê¹€ì² ìˆ˜', team: 'ITìš´ì˜íŒ€', reason: 'ì›¹ì„œë²„ ì·¨ì•½ì  ë¶„ì„ ë° ë³´ì•ˆ ê°•í™”' },
      { id: 'WP-2025-010', title: 'ë°ì´í„°ì„¼í„° í™˜ê²½ ì ê²€', registrant: 'ì´ì˜í¬', team: 'ì‹œìŠ¤í…œíŒ€', reason: 'ë°ì´í„°ì„¼í„° ì˜¨ë„, ìŠµë„, ì „ë ¥ ì‹œìŠ¤í…œ ì ê²€' },
      { id: 'WP-2025-011', title: 'ì¸ì¦ì„œ ê°±ì‹  ì‘ì—…', registrant: 'ë°•ë¯¼ìˆ˜', team: 'ë³´ì•ˆíŒ€', reason: 'SSL ì¸ì¦ì„œ ë§Œë£Œ ì „ ì‚¬ì „ ê°±ì‹ ' },
      { id: 'WP-2025-012', title: 'ë„¤íŠ¸ì›Œí¬ ìš©ëŸ‰ ì¦ì„¤', registrant: 'ì •ë¯¼í˜¸', team: 'ë„¤íŠ¸ì›Œí¬íŒ€', reason: 'ì¦ê°€í•œ íŠ¸ë˜í”½ ëŒ€ì‘ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ì¦ì„¤' }
    ];

    // ì‘ì—…ê³„íšì„œ ì¡°íšŒ í•¨ìˆ˜ (ë¡œì»¬ ë°ì´í„° ì‚¬ìš©)
    function searchWorkplans(filterByName = null) {
      console.log(`ğŸ” ì‘ì—…ê³„íšì„œ ì¡°íšŒ ì‹œì‘ ${filterByName ? `(ë‹´ë‹¹ì: ${filterByName})` : ''}`);
      
      // ë‹´ë‹¹ì ì´ë¦„ìœ¼ë¡œ í•„í„°ë§ (ì œê³µëœ ê²½ìš°)
      let workplans = WORKPLAN_SAMPLE_DATA;
      if (filterByName) {
        workplans = WORKPLAN_SAMPLE_DATA.filter(plan => plan.registrant === filterByName);
        console.log(`ğŸ“‹ ${filterByName}ë‹˜ì˜ ì‘ì—…ê³„íšì„œ ${workplans.length}ê±´ ì¡°íšŒë¨`);
      }
      
      const planList = document.getElementById('planList');
      const searchResults = document.getElementById('searchResults');
      const directInputSection = document.getElementById('directInputSection');
      const selectedPlan = document.getElementById('selectedPlan');
      
      // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
      planList.innerHTML = '';
      selectedPlan.classList.add('d-none');
      
      if (workplans.length > 0) {
        // ì¡°íšŒ ê²°ê³¼ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ í‘œì‹œ
        workplans.forEach((plan, index) => {
          const planItem = document.createElement('div');
          planItem.className = 'plan-item';
          planItem.setAttribute('data-plan-id', plan.id);
          planItem.setAttribute('data-plan-reason', plan.reason);
          
          planItem.innerHTML = `
            <div class="plan-item-header">
              ${plan.id} - ${plan.title}
              <span class="plan-item-registrant">ë‹´ë‹¹: ${plan.registrant}</span>
            </div>
            <div class="plan-item-details">
              ${plan.reason}
            </div>
          `;
          
          // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
          planItem.addEventListener('click', () => {
            selectWorkplan(plan);
          });
          
          planList.appendChild(planItem);
        });
        
        // ì¡°íšŒ ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
        searchResults.classList.remove('d-none');
        directInputSection.classList.add('d-none');
        
        // í•„í„°ë§ëœ ê²½ìš° ì¶”ê°€ ì•ˆë‚´ ë©”ì‹œì§€
        const infoText = document.querySelector('#searchResults small');
        if (filterByName) {
          if (workplans.length > 0) {
            infoText.innerHTML = `<strong>âœ… ${filterByName}ë‹˜ì˜ ì‘ì—…ê³„íšì„œ ${workplans.length}ê±´ì´ ì¡°íšŒë˜ì—ˆìŠµë‹ˆë‹¤.</strong><br>ì›í•˜ëŠ” ì‘ì—…ê³„íšì„œë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ê±°ë‚˜ 'ì§ì ‘ ì…ë ¥'ì„ ì´ìš©í•˜ì„¸ìš”.`;
            infoText.style.color = '#28a745'; // ì„±ê³µ ìƒ‰ìƒ
          }
        } else {
          infoText.innerHTML = `<strong>ğŸ“‹ ì „ì²´ ì‘ì—…ê³„íšì„œ ${workplans.length}ê±´ì´ ì¡°íšŒë˜ì—ˆìŠµë‹ˆë‹¤.</strong><br>ì›í•˜ëŠ” ì‘ì—…ê³„íšì„œë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ê±°ë‚˜ 'ì§ì ‘ ì…ë ¥'ì„ ì´ìš©í•˜ì„¸ìš”.`;
          infoText.style.color = '#17a2b8'; // ì •ë³´ ìƒ‰ìƒ
        }
        
      } else {
        const message = filterByName ? 
          `${filterByName}ë‹˜ì˜ ë“±ë¡ëœ ì‘ì—…ê³„íšì„œê°€ ì—†ìŠµë‹ˆë‹¤.` : 
          'ì¡°íšŒëœ ì‘ì—…ê³„íšì„œê°€ ì—†ìŠµë‹ˆë‹¤.';
        
        if (filterByName) {
          // ìë™ ì¡°íšŒì—ì„œ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°ëŠ” ì•Œë¦¼ì„ ë„ìš°ì§€ ì•Šê³  ë¡œê·¸ë§Œ
          console.log(`ğŸ“‹ ${message}`);
          
          // ì•ˆë‚´ ë©”ì‹œì§€ë§Œ í‘œì‹œ
          const infoText = document.querySelector('#searchResults small');
          if (infoText) {
            infoText.innerHTML = `<strong>â„¹ï¸ ${message}</strong><br>'ì‘ì—…ê³„íšì„œ ì¡°íšŒ' ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜ 'ì§ì ‘ ì…ë ¥'ì„ ì´ìš©í•˜ì„¸ìš”.`;
            infoText.style.color = '#17a2b8'; // ì •ë³´ ìƒ‰ìƒ
          }
        } else {
          // ìˆ˜ë™ ì¡°íšŒì—ì„œ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°ë§Œ ì•Œë¦¼
          alert(message + ' ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          showDirectInput();
        }
      }
    }

    // ì‘ì—…ê³„íšì„œ ì„ íƒ í•¨ìˆ˜
    function selectWorkplan(plan) {
      console.log(`ğŸ“‹ ì‘ì—…ê³„íšì„œ ì„ íƒ: ${plan.id}`);
      
      // ëª¨ë“  plan-itemì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
      document.querySelectorAll('.plan-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // ì„ íƒëœ ì•„ì´í…œì— selected í´ë˜ìŠ¤ ì¶”ê°€
      const selectedItem = document.querySelector(`[data-plan-id="${plan.id}"]`);
      if (selectedItem) {
        selectedItem.classList.add('selected');
      }
      
      // hidden inputì— ê°’ ì„¤ì •
      document.querySelector('input[name="plan_number_final"]').value = plan.id;
      
      // ì„ íƒëœ ì‘ì—…ê³„íšì„œ ì •ë³´ í‘œì‹œ
      const selectedPlanInfo = document.getElementById('selectedPlanInfo');
      selectedPlanInfo.innerHTML = `
        <strong>${plan.id}</strong> - ${plan.title}<br>
        <small class="text-muted">ë‹´ë‹¹: ${plan.registrant} | ${plan.reason}</small>
      `;
      document.getElementById('selectedPlan').classList.remove('d-none');
      
      // ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ì¶œì…ì‚¬ìœ  ìë™ ì—…ë°ì´íŠ¸
      if (document.getElementById('sameAsWorkplan').checked) {
        updateReasonFromWorkplan(plan.id);
      }
    }

    // ì§ì ‘ ì…ë ¥ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('directInputBtn').addEventListener('click', () => {
      showDirectInput();
    });

    // ì§ì ‘ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
    document.addEventListener('input', (e) => {
      if (e.target.name === 'plan_number') {
        const planNumber = e.target.value.trim();
        document.querySelector('input[name="plan_number_final"]').value = planNumber;
        
        // ì„ íƒëœ ì‘ì—…ê³„íšì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
        if (planNumber) {
          const selectedPlanInfo = document.getElementById('selectedPlanInfo');
          selectedPlanInfo.innerHTML = `<strong>${planNumber}</strong> - ì§ì ‘ ì…ë ¥ëœ ì‘ì—…ê³„íšì„œ`;
          document.getElementById('selectedPlan').classList.remove('d-none');
        } else {
          document.getElementById('selectedPlan').classList.add('d-none');
        }
        
        // ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ì¶œì…ì‚¬ìœ  ìë™ ì—…ë°ì´íŠ¸
        if (document.getElementById('sameAsWorkplan').checked) {
          updateReasonFromWorkplan(planNumber);
        }
      }
    });

    // ì‘ì—…ê³„íšì„œ ì‚¬ìœ ì™€ ë™ì¼ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    document.getElementById('sameAsWorkplan').addEventListener('change', (e) => {
      const reasonInput = document.getElementById('reasonInput');
      const isChecked = e.target.checked;
      const currentPlanNumber = document.querySelector('input[name="plan_number_final"]').value;
      
      if (isChecked) {
        reasonInput.readOnly = true; // 'disabled'ë¥¼ 'readOnly'ë¡œ ë³€ê²½
        reasonInput.style.backgroundColor = '#e9ecef';
        updateReasonFromWorkplan(currentPlanNumber);
      } else {
        reasonInput.readOnly = false; // 'disabled'ë¥¼ 'readOnly'ë¡œ ë³€ê²½
        reasonInput.style.backgroundColor = '#f8f9fa';
        reasonInput.value = '';
      }
    });

    // ì§ì ‘ ì…ë ¥ ì„¹ì…˜ í‘œì‹œ í•¨ìˆ˜
    function showDirectInput() {
      const searchResults = document.getElementById('searchResults');
      const directInputSection = document.getElementById('directInputSection');
      const selectedPlan = document.getElementById('selectedPlan');
      
      searchResults.classList.add('d-none');
      directInputSection.classList.remove('d-none');
      selectedPlan.classList.add('d-none');
      
      // ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ì¶œì…ì‚¬ìœ  ì´ˆê¸°í™”
      if (document.getElementById('sameAsWorkplan').checked) {
        document.getElementById('reasonInput').value = '';
      }
    }

    // ì‘ì—…ê³„íšì„œ ì„¹ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
    function resetPlanSection() {
      const searchResults = document.getElementById('searchResults');
      const directInputSection = document.getElementById('directInputSection');
      const selectedPlan = document.getElementById('selectedPlan');
      const planList = document.getElementById('planList');
      
      searchResults.classList.add('d-none');
      directInputSection.classList.add('d-none');
      selectedPlan.classList.add('d-none');
      
      // ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
      if (planList) {
        planList.innerHTML = '';
      }
      
      document.querySelector('input[name="plan_number_final"]').value = '';
      
      // ì§ì ‘ ì…ë ¥ í•„ë“œê°€ ìˆë‹¤ë©´ ì´ˆê¸°í™”
      const directInput = document.querySelector('input[name="plan_number"]');
      if (directInput) {
        directInput.value = '';
      }
      
      // ì²´í¬ë°•ìŠ¤ ë° ì¶œì…ì‚¬ìœ  ì´ˆê¸°í™”
      const sameAsWorkplanCheckbox = document.getElementById('sameAsWorkplan');
      const reasonInput = document.getElementById('reasonInput');
      
      sameAsWorkplanCheckbox.checked = false;
      reasonInput.disabled = false;
      reasonInput.style.backgroundColor = '#f8f9fa';
      reasonInput.value = '';
    }

    // ì‘ì—…ê³„íšì„œ ì‚¬ìœ ë¡œ ì¶œì…ì‚¬ìœ  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateReasonFromWorkplan(planNumber) {
      const reasonInput = document.getElementById('reasonInput');
      
      if (!planNumber) {
        reasonInput.value = '';
        return;
      }
      
      // WORKPLAN_SAMPLE_DATAì—ì„œ í•´ë‹¹ ì‘ì—…ê³„íšì„œ ì°¾ê¸°
      const workplan = WORKPLAN_SAMPLE_DATA.find(plan => plan.id === planNumber);
      
      if (workplan && workplan.reason) {
        reasonInput.value = workplan.reason;
      } else {
        reasonInput.value = 'ì‘ì—…ê³„íšì„œì— ê¸°ì¬ëœ ì‚¬ìœ ';
      }
    }

    // âœ… [ì¶”ê°€] ì„¤ì • í˜ì´ì§€ ì´ë™ ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¬»ëŠ” í•¨ìˆ˜
    async function goToSettings() {
      const enteredPassword = prompt('ì„¤ì • í˜ì´ì§€ì— ì ‘ê·¼í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

      // ì‚¬ìš©ìê°€ 'ì·¨ì†Œ'ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šì€ ê²½ìš° í•¨ìˆ˜ ì¢…ë£Œ
      if (!enteredPassword) {
        return;
      }

      try {
        // ì„œë²„ì˜ /api/login ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ìš”ì²­
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ password: enteredPassword }),
        });

        if (response.ok) {
          // ì¸ì¦ ì„±ê³µ ì‹œ, settings.htmlì´ ì ‘ê·¼ì„ í—ˆìš©í•˜ë„ë¡ sessionStorageì— í”Œë˜ê·¸ ì €ì¥
          sessionStorage.setItem('settings_access_granted', 'true');
          // settings.html í˜ì´ì§€ë¡œ ì´ë™
          window.location.href = '/settings.html';
        } else {
          // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì„œë²„ê°€ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
          const result = await response.json();
          alert(result.message || 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('ë¡œê·¸ì¸ ìš”ì²­ ì˜¤ë¥˜:', error);
        alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      }
    }
    
  </script>
</body>
</html>